name: Apply Inbox Patch

on:
  push:
    branches: [ main ]
    paths:
      - '.wtp/inbox/*.patch'
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: apply-inbox
  cancel-in-progress: true

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Ensure folders
        run: |
          mkdir -p .wtp/inbox .wtp/processed

      - name: Apply all patches (3-way, idempotent) + archive with timestamp
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          PATCHES=(.wtp/inbox/*.patch)
          if [ ${#PATCHES[@]} -eq 0 ]; then
            echo "Inbox empty. Nothing to do."
            exit 0
          fi

          CHANGED=0
          for P in "${PATCHES[@]}"; do
            BN="$(basename "$P")"
            TS="$(date -u +%Y%m%dT%H%M%SZ)"
            OUT=".wtp/processed/${BN%.patch}-${TS}.patch"

            echo ">> Applying: $BN"
            if git apply --check --3way "$P"; then
              git apply --3way "$P"
              CHANGED=1
              echo "Applied: $BN"
            else
              echo "Nothing to apply or already applied: $BN (ok)"
            fi

            # Zarchiwizuj z timestampem i usu≈Ñ z inbox
            cp -f "$P" "$OUT"
            rm -f "$P"
          done

          if git status --porcelain | grep -qE '^( M|A |D )'; then
            git add -A
            git commit -m "[apply-inbox] processed patches"
            git push origin HEAD:main
          else
            echo "No repo changes to commit."
          fi
