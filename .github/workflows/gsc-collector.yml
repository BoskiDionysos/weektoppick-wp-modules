name: GSC collector

on:
  workflow_dispatch:

permissions:
  id-token: write        # konieczne do OIDC
  contents: read

env:
  # dokÅ‚adnie jak w Search Console, np. "sc-domain:weektoppick.com"
  GSC_SITE: ${{ secrets.WTP_GSC_SITE }}

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google (OIDC)
        id: google-auth
        uses: google-github-actions/auth@v2
        with:
          # ðŸ‘‡ JEDYNY sposÃ³b uwierzytelniania â€“ OIDC (bez credentials_json)
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: wtp-gsc-collector@weektoppick.iam.gserviceaccount.com
          token_format: access_token
          access_token_scopes: https://www.googleapis.com/auth/webmasters.readonly

      # --- KRÃ“TKI DEBUG (pomoÅ¼e natychmiast zÅ‚apaÄ‡ problem) ---
      - name: Debug â€“ pokaÅ¼ scope access tokena
        env:
          TOKEN: ${{ steps.google-auth.outputs.access_token }}
        run: |
          set -euo pipefail
          curl -sS "https://oauth2.googleapis.com/tokeninfo?access_token=${TOKEN}" | jq '{scopes: .scope}'

      - name: Debug â€“ czy SA widzi Twoje wÅ‚aÅ›ciwoÅ›ci GSC?
        env:
          TOKEN: ${{ steps.google-auth.outputs.access_token }}
        run: |
          set -euo pipefail
          curl -sS -H "Authorization: Bearer ${TOKEN}" \
               "https://searchconsole.googleapis.com/webmasters/v3/sites" | jq .

      # --- WÅ‚aÅ›ciwe zapytanie ---
      - name: Query GSC Search Analytics (last 7 days)
        env:
          TOKEN: ${{ steps.google-auth.outputs.access_token }}
          SITE: ${{ env.GSC_SITE }}
        run: |
          set -euo pipefail
          START=$(date -u -d '7 days ago' +%Y-%m-%d)
          END=$(date -u -d '1 day ago' +%Y-%m-%d)
          BODY=$(jq -n --arg start "$START" --arg end "$END" \
            '{startDate:$start, endDate:$end, dimensions:["query","page"], rowLimit:2500}')

          SITE_URI=$(printf '%s' "$SITE" | jq -sRr @uri)
          URL="https://searchconsole.googleapis.com/webmasters/v3/sites/${SITE_URI}/searchAnalytics/query"

          code=$(curl -sS -o gsc-raw.json -w "%{http_code}" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -X POST "$URL" \
            --data-binary "$BODY")

          echo "HTTP=$code"
          if [ "$code" -ge 400 ]; then
            echo "==== GSC error body (trimmed) ===="
            head -c 4000 gsc-raw.json || true
            echo
            exit 1
          fi

          jq . gsc-raw.json | tee gsc-pretty.json >/dev/null

      - name: Upload artifacts (raw + pretty)
        uses: actions/upload-artifact@v4
        with:
          name: gsc-results
          path: |
            gsc-raw.json
            gsc-pretty.json
