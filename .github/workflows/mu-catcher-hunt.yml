name: mu-catcher-hunt

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  hunt:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      HOST:   ${{ secrets.DEPLOY_HOST }}
      PORT:   ${{ secrets.DEPLOY_PORT }}
      USER:   ${{ secrets.DEPLOY_USER }}
      PASS:   ${{ secrets.DEPLOY_PASS }}
      TARGET: ${{ secrets.DEPLOY_TARGET }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Kill catcher + sterilize safe-loader (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ env.HOST }}
          port:     ${{ env.PORT }}
          username: ${{ env.USER }}
          password: ${{ env.PASS }}
          command_timeout: 3m
          script_stop: true
          envs: TARGET
          script: |
            bash -lc '
              set -eu

              # Wejście do katalogu WP
              if [ -n "${TARGET:-}" ] && [ -d "${TARGET}" ]; then
                cd "${TARGET}"
              else
                cd "${HOME}/public_html"
              fi
              echo "PWD=$(pwd)"

              echo "== BEFORE =="
              ls -la wp-content/mu-plugins | head -n 200 || true

              # 1) Usuń WSZYSTKIE wystąpienia wtp-fatal-catcher.php w mu-plugins (bez mapfile i proc-subst)
              FOUND=0
              IFS="
              "
              for f in $(find wp-content/mu-plugins -type f -name "wtp-fatal-catcher.php" 2>/dev/null || true); do
                FOUND=1
                echo "Removing $f"
                rm -f "$f" || true
              done
              if [ "$FOUND" -eq 0 ]; then
                echo "No wtp-fatal-catcher.php in mu-plugins (good)."
              fi
              unset IFS

              # 2) Twarda, sterylna wersja 00-mu-safe-loader.php (zero outputu, zero BOM)
              #    Używam printf żeby uniknąć CR/LF i BOM
              printf "%s\n" "<?php" > wp-content/mu-plugins/00-mu-safe-loader.php
              {
                printf "%s\n" 'if (!defined("ABSPATH")) { exit; }'
                printf "%s\n" 'add_action("muplugins_loaded", static function () {'
                printf "%s\n" '    // silence is golden'
                printf "%s\n" '}, 0);'
              } >> wp-content/mu-plugins/00-mu-safe-loader.php

              # 3) Reset OPcache (jeśli aktywny)
              php -r '\''if(function_exists("opcache_reset")){opcache_reset();echo "OPCACHE_RESET_OK\n";}else{echo "NO_OPCACHE\n";}'\'' || true

              echo "== AFTER =="
              ls -la wp-content/mu-plugins | head -n 200 || true
            '
