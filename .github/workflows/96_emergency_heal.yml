name: 96_emergency_heal
on:
  workflow_dispatch:

jobs:
  heal:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      HOST:   ${{ secrets.DEPLOY_HOST }}
      PORT:   ${{ secrets.DEPLOY_PORT }}
      USER:   ${{ secrets.DEPLOY_USER }}
      PASS:   ${{ secrets.DEPLOY_PASS }}
      TARGET: ${{ secrets.DEPLOY_TARGET }}

    steps:
      - name: Heal via SSH (MU off → plugins off → theme TT25 → purge → ping)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ env.HOST }}
          username: ${{ env.USER }}
          password: ${{ env.PASS }}
          port:     ${{ env.PORT }}
          envs: TARGET
          script: |
            set -euo pipefail
            TARGET="${TARGET:-/home/${USER}/domains/weektoppick.com/public_html}"
            cd "$TARGET" || exit 1
            rm -f .maintenance || true

            # 1) MU-plugins OFF (wszystkie)
            if [ -d wp-content/mu-plugins ]; then
              for f in wp-content/mu-plugins/*.php; do
                [ -f "$f" ] && mv -f "$f" "$f.off" || true
              done
            fi

            # 2) Plugins OFF, motyw TT25
            if command -v wp >/dev/null 2>&1; then
              wp plugin deactivate --all --quiet || true
              wp theme install twentytwentyfive --activate --force || wp theme activate twentytwentyfive || true
              wp plugin activate litespeed-cache || true
              wp plugin is-active litespeed-cache && wp litespeed-purge all || true
            fi

            # 3) Szybki ping frontu
            HOMEURL="$(php -r 'include "wp-config.php"; include "wp-load.php"; echo get_option("home");' 2>/dev/null || true)"
            HOMEURL="${HOMEURL:-https://weektoppick.com}"
            CODE="$(curl -ks -o /dev/null -w "%{http_code}" "$HOMEURL" || echo 000)"
            echo "[INFO] front status: $CODE"
