name: 03_snapshot (WordPress → SSOT, pełny stan)

on:
  workflow_run:
    workflows: ["02_wpcli (install/update/activate from SSOT, secure SSH)"]
    types: [completed]
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *"    # 2) codzienny snapshot o 03:00 UTC

permissions:
  contents: write

concurrency:
  group: snapshot
  cancel-in-progress: true

jobs:
  snapshot:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      WTP_CI: "1"
      HOST:   ${{ secrets.DEPLOY_HOST }}
      PORT:   ${{ secrets.DEPLOY_PORT }}
      USER:   ${{ secrets.DEPLOY_USER }}
      PASS:   ${{ secrets.DEPLOY_PASS }}
      TARGET: ${{ secrets.DEPLOY_TARGET }}
      SITE_KEY: ${{ secrets.WTP_SITE_KEY }}

    steps:
      - name: 1) Checkout repo
        uses: actions/checkout@v4

      - name: 2) Setup tools + known_hosts (STRICT)
        shell: bash
        run: |
          set -euo pipefail
          for v in HOST PORT USER PASS TARGET; do
            [ -n "${!v:-}" ] || { echo "::error::Missing $v"; exit 1; }
          done
          sudo apt-get update -y
          sudo apt-get install -y curl sshpass jq
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          ssh-keyscan -p "${PORT}" "${HOST}" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          echo "::add-mask::$HOST"
          echo "::add-mask::$USER"

      - name: 3) Prepare local dirs
        shell: bash
        run: mkdir -p "_ci_logs/${{ github.run_id }}/snapshot"

      - name: 4) Create & upload snapshot script (PHP aggregator + RO publish)
        shell: bash
        run: |
          set -euo pipefail
          cat > /tmp/wtp_snapshot.sh <<'SNAPEOF'
          #!/usr/bin/env bash
          set -euo pipefail

          : "${TARGET:?TARGET is required}"
          : "${RUN_ID:?RUN_ID is required}"

          LOGDIR="${TARGET}/.wtp/state/ci_logs/snapshot"
          mkdir -p "${LOGDIR}"

          ERR_FILE="${LOGDIR}/errors.txt"; : > "${ERR_FILE}"
          note_err(){ echo "$1" | tee -a "${ERR_FILE}" 1>&2 || true; }
          run_wp(){ php ./wp "$@" --path="${TARGET}"; }

          # ---------- A) Site/Core ----------
          SITE_URL="$(run_wp option get siteurl 2>/dev/null || true)"
          SITE_HOME="$(run_wp option get home 2>/dev/null || true)"
          WP_VER="$(run_wp core version 2>/dev/null || true)"
          TABLE_PREFIX="$(grep -E "^\s*\\\$table_prefix\s*=" "${TARGET}/wp-config.php" 2>/dev/null | sed -E "s/.*['\"]([^'\"]+)['\"].*/\1/" | head -n1 || echo "wp_")"
          WPLANG="$(run_wp option get WPLANG 2>/dev/null || true)"
          TZ_STR="$(run_wp option get timezone_string 2>/dev/null || run_wp option get gmt_offset 2>/dev/null || true)"
          PHP_VERSION="$(php -r 'echo PHP_VERSION;' 2>/dev/null || true)"
          php -v > "${LOGDIR}/php_info.txt" 2>&1 || note_err "php -v failed."

          {
            printf '%s\n' '{'
            printf '  "url": "%s",\n' "${SITE_URL}"
            printf '  "home": "%s",\n' "${SITE_HOME}"
            printf '  "wp_version": "%s",\n' "${WP_VER}"
            printf '  "table_prefix": "%s",\n' "${TABLE_PREFIX}"
            printf '  "language": "%s",\n' "${WPLANG}"
            printf '  "timezone": "%s",\n' "${TZ_STR}"
            printf '  "php_version": "%s"\n' "${PHP_VERSION}"
            printf '%s\n' '}'
          } > "${LOGDIR}/site_info.json" || note_err "site_info.json write failed."

          # ---------- B) Themes ----------
          run_wp theme list --status=active --format=json > "${LOGDIR}/theme_active.json" 2>>"${ERR_FILE}" || note_err "wp theme list --status=active failed."
          run_wp theme list --format=json > "${LOGDIR}/themes.json" 2>>"${ERR_FILE}" || note_err "wp theme list --format=json failed."

          # ---------- C) Plugins ----------
          run_wp plugin list --format=json > "${LOGDIR}/plugins.json" 2>>"${ERR_FILE}" || note_err "wp plugin list --format=json failed."
          run_wp plugin list --format=csv  > "${LOGDIR}/plugins.csv"  2>>"${ERR_FILE}" || note_err "wp plugin list --format=csv failed."

          # ---------- C2) Per-plugin trees + SHA1 ----------
          PLUG_DIR="${TARGET}/wp-content/plugins"
          if [[ -d "${PLUG_DIR}" ]]; then
            if [[ -s "${LOGDIR}/plugins.json" ]]; then
              sed -n 's/.*"name"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' "${LOGDIR}/plugins.json" | sort -u > "${LOGDIR}/_slugs.txt" || true
            else
              find "${PLUG_DIR}" -mindepth 1 -maxdepth 1 -type d -printf '%f\n' | sort > "${LOGDIR}/_slugs.txt" || true
            fi
            while IFS= read -r slug; do
              [[ -n "$slug" && -d "${PLUG_DIR}/${slug}" ]] || continue
              OUTDIR="${LOGDIR}/plugins/${slug}"; mkdir -p "${OUTDIR}"
              find "${PLUG_DIR}/${slug}" -type f -print0 | sort -z | tr '\0' '\n' > "${OUTDIR}/tree.txt" 2>>"${ERR_FILE}" || true
              { find "${PLUG_DIR}/${slug}" -type f -print0 | sort -z | xargs -0 sha1sum; } > "${OUTDIR}/hashes.sha1" 2>>"${ERR_FILE}" || true
            done < "${LOGDIR}/_slugs.txt"
          fi

          # ---------- D) MU-plugins ----------
          MU_DIR="${TARGET}/wp-content/mu-plugins"
          mkdir -p "${LOGDIR}/mu-plugins"
          if [[ -d "${MU_DIR}" ]]; then
            ls -la "${MU_DIR}" > "${LOGDIR}/mu-plugins/_ls.txt" 2>>"${ERR_FILE}" || note_err "ls mu-plugins failed."
            find "${MU_DIR}" -type f -print0 | sort -z | xargs -0 sha1sum > "${LOGDIR}/mu-plugins/_hashes.txt" 2>>"${ERR_FILE}" || true
            find "${MU_DIR}" -maxdepth 1 -type f -name "*.php" -print0 | \
              while IFS= read -r -d '' f; do
                head -n 50 "$f" | grep -E "^\s*\*\s*Plugin Name:" -m1 > "${LOGDIR}/mu-plugins/$(basename "$f").header.txt" 2>>"${ERR_FILE}" || true
              done
          else
            echo "mu-plugins directory not found." > "${LOGDIR}/mu-plugins/_ls.txt"
            : > "${LOGDIR}/mu-plugins/_hashes.txt"
          fi
          run_wp plugin list --status=must-use --format=json > "${LOGDIR}/mu_plugins.json" 2>>"${ERR_FILE}" || note_err "wp plugin list --status=must-use failed."

          # ---------- E) Users ----------
          run_wp user list --role=administrator --field=user_login --format=json > "${LOGDIR}/admins.json" 2>>"${ERR_FILE}" || note_err "wp user list --role=administrator failed."

          # ---------- F) WTP / SSOT ----------
          SSOT_PATH="${TARGET}/.wtp/ssot.yml"; SSOT_SHA1=""; SSOT_B64=""
          if [[ -f "${SSOT_PATH}" ]]; then
            cp "${SSOT_PATH}" "${LOGDIR}/ssot.yml" 2>>"${ERR_FILE}" || note_err "Copy ssot.yml failed."
            SSOT_SHA1="$(sha1sum "${SSOT_PATH}" | awk '{print $1}')" || true
            echo "${SSOT_SHA1}" > "${LOGDIR}/ssot.sha1" || true
            SSOT_B64="$(base64 -w0 "${SSOT_PATH}" 2>/dev/null || base64 "${SSOT_PATH}" | tr -d '\n')" || true
          else
            note_err "SSOT file .wtp/ssot.yml not found."
          fi

          # ---------- G) Server ----------
          SERVER_USER="$(whoami 2>/dev/null || true)"
          SERVER_UNAME="$(uname -a 2>/dev/null || true)"
          SERVER_DT="$(date -Is 2>/dev/null || true)"
          SERVER_CWD="$(cd "${TARGET}" && pwd 2>/dev/null || true)"
          {
            echo "user: ${SERVER_USER}"
            echo "uname: ${SERVER_UNAME}"
            echo "datetime: ${SERVER_DT}"
            echo "cwd: ${SERVER_CWD}"
          } > "${LOGDIR}/server_info.txt" 2>>"${ERR_FILE}" || note_err "server_info.txt failed."

          # ---------- H) Summary (active list) ----------
          run_wp plugin list --status=active --field=name --format=json > "${LOGDIR}/plugins_active.json" 2>>"${ERR_FILE}" || note_err "wp plugin list --status=active --field=name failed."
          if [[ -s "${LOGDIR}/plugins_active.json" ]]; then
            sed -n 's/[^"[]*"\([^"]\+\)".*/\1/p' "${LOGDIR}/plugins_active.json" > "${LOGDIR}/plugins_active.txt" 2>>"${ERR_FILE}" || true
          else
            : > "${LOGDIR}/plugins_active.txt"
          fi

          # ---------- I) Build snapshot.json w PHP (bez jq) ----------
          cat > /tmp/wtp_build_snapshot.php <<'PHPBUILDER'
          <?php
          error_reporting(E_ALL);
          $logdir = getenv('LOGDIR');
          $runId  = getenv('RUN_ID');
          $ts     = date('c');

          function jread($p,$d){ return ($p && is_readable($p)) ? (json_decode(file_get_contents($p), true) ?? $d) : $d; }
          function fread_or($p,$d=''){ return ($p && is_readable($p)) ? file_get_contents($p) : $d; }

          $site   = jread("$logdir/site_info.json", new stdClass());
          $themes = jread("$logdir/themes.json", []);
          $tact   = jread("$logdir/theme_active.json", []);
          $themeActive = (is_array($tact) && count($tact)>0) ? $tact[0] : null;

          $pluginsStd = jread("$logdir/plugins.json", []);
          $pluginsMU  = jread("$logdir/mu_plugins.json", []);
          $admins     = jread("$logdir/admins.json", []);
          $pluginsActive = jread("$logdir/plugins_active.json", []);

          // trees
          $trees = [];
          $pluginsDir = "$logdir/plugins";
          if (is_dir($pluginsDir)) {
            foreach (scandir($pluginsDir) as $slug) {
              if ($slug==='.'||$slug==='..') continue;
              $pdir = "$pluginsDir/$slug"; if(!is_dir($pdir)) continue;
              $treeFile="$pdir/tree.txt"; $hashes="$pdir/hashes.sha1";
              $files = (is_readable($treeFile)) ? max(0,count(file($treeFile, FILE_IGNORE_NEW_LINES))) : 0;
              $sha = '';
              if (is_readable($hashes)) {
                $all=preg_replace('/\s+.*/','',file_get_contents($hashes));
                $all=preg_replace('/\s+/','',$all);
                $sha=substr(sha1($all),0,40);
              }
              $trees[$slug]=['files'=>$files,'sha1'=>$sha];
            }
          }

          // counts (standard != must-use)
          $stdOnly = array_values(array_filter($pluginsStd, fn($p)=>is_array($p) && (($p['status']??'')!=='must-use')));
          $counts = [
            'themes_total'   => is_array($themes)?count($themes):0,
            'plugins_total'  => count($stdOnly),
            'plugins_active' => is_array($pluginsActive)?count($pluginsActive):0,
            'plugins_mu'     => is_array($pluginsMU)?count($pluginsMU):0,
            'admins'         => is_array($admins)?count($admins):0
          ];

          // errors
          $errors = [];
          $errPath = "$logdir/errors.txt";
          if (is_readable($errPath)) {
            $errors = array_values(array_filter(array_map('trim', file($errPath))));
          }

          // server
          $srv=['user'=>'','uname'=>'','datetime'=>'','cwd'=>''];
          $si=fread_or("$logdir/server_info.txt");
          if($si){
            foreach(explode("\n",$si) as $ln){
              if(preg_match('/^([a-z]+):\s*(.*)$/i',trim($ln),$m)){ $srv[$m[1]]=$m[2]; }
            }
          }

          // ssot
          $ssot_path='.wtp/ssot.yml';
          $ssot_sha1=trim(fread_or("$logdir/ssot.sha1"));
          $ssot_b64= is_readable("$logdir/ssot.yml") ? base64_encode(file_get_contents("$logdir/ssot.yml")) : '';

          $out = [
            'run_id'=>(int)$runId,
            'timestamp'=>$ts,
            'site'=>$site,
            'server'=>$srv,
            'theme'=>['active'=>$themeActive,'all'=>$themes],
            'plugins'=>['standard'=>$pluginsStd,'must_use'=>$pluginsMU,'trees'=>$trees],
            'admins'=>$admins,
            'summary'=>['plugins_active'=>$pluginsActive,'counts'=>$counts,'errors'=>$errors],
            'wtp'=>['ssot_path'=>$ssot_path,'ssot_sha1'=>$ssot_sha1,'ssot_b64'=>$ssot_b64]
          ];

          file_put_contents("$logdir/snapshot.json", json_encode($out, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE));
          PHPBUILDER

          LOGDIR="${LOGDIR}" RUN_ID="${RUN_ID}" php /tmp/wtp_build_snapshot.php 2>>"${ERR_FILE}" || note_err "snapshot.json build failed."
          rm -f /tmp/wtp_build_snapshot.php || true

          # ---------- J) Publish to RO (public URL) ----------
          if [[ -n "${SITE_KEY:-}" ]]; then
            PUB_DIR="${TARGET}/wp-content/uploads/wtp-ro/public/${SITE_KEY}"
            mkdir -p "${PUB_DIR}" || note_err "Cannot create ${PUB_DIR}"
            cp -f "${LOGDIR}/snapshot.json" "${PUB_DIR}/snapshot.json" 2>>"${ERR_FILE}" || note_err "Copy snapshot.json -> latest failed."
            cp -f "${LOGDIR}/snapshot.json" "${PUB_DIR}/snapshot-${RUN_ID}.json" 2>>"${ERR_FILE}" || note_err "Copy snapshot.json -> versioned failed."
            cp -f "${LOGDIR}/plugins.json" "${PUB_DIR}/plugins.json" 2>/dev/null || true
            cp -f "${LOGDIR}/themes.json"  "${PUB_DIR}/themes.json"  2>/dev/null || true
            cp -f "${LOGDIR}/mu_plugins.json" "${PUB_DIR}/mu_plugins.json" 2>/dev/null || true
          else
            note_err "RO publish skipped: SITE_KEY empty."
          fi
          SNAPEOF

          chmod +x /tmp/wtp_snapshot.sh
          sshpass -p "${PASS}" scp -P "${PORT}" -o StrictHostKeyChecking=yes /tmp/wtp_snapshot.sh ${USER}@${HOST}:/tmp/wtp_snapshot.sh

      - name: 5) Run remote snapshot script
        shell: bash
        run: |
          set -euo pipefail
          sshpass -p "${PASS}" ssh -p "${PORT}" -o StrictHostKeyChecking=yes \
            "${USER}@${HOST}" "RUN_ID='${{ github.run_id }}' TARGET='${TARGET}' SITE_KEY='${SITE_KEY:-}' bash /tmp/wtp_snapshot.sh && rm -f /tmp/wtp_snapshot.sh"

      - name: 6) Pull logs back
        shell: bash
        run: |
          set -euo pipefail
          sshpass -p "${PASS}" scp -P "${PORT}" -o StrictHostKeyChecking=yes -r \
            "${USER}@${HOST}:${TARGET}/.wtp/state/ci_logs/snapshot" "_ci_logs/${{ github.run_id }}/"

      - name: 7) Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-logs-${{ github.run_id }}
          path: _ci_logs/${{ github.run_id }}/snapshot/**

      - name: 8) Validate snapshot.json
        shell: bash
        run: |
          set -euo pipefail
          SNAP="_ci_logs/${{ github.run_id }}/snapshot/snapshot.json"
          if [[ -s "$SNAP" ]]; then
            echo "::notice::Snapshot JSON created ($(wc -c < "$SNAP") bytes)"
            jq empty "$SNAP" || echo "::warning::JSON may be malformed"
          else
            echo "::error::No snapshot.json generated"; exit 1
          fi

      - name: 8.5) Publish & print snapshot summary (public)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          SNAP="_ci_logs/${{ github.run_id }}/snapshot/snapshot.json"
          if [[ -s "$SNAP" ]]; then
            OUT="_ci_logs/${{ github.run_id }}/snapshot/snapshot-summary.json"
            SNAP="$SNAP" OUT="$OUT" php -r '
              $snap = getenv("SNAP") ?: "";
              if ($snap === "" || !is_readable($snap)) { exit(0); }
              $j = json_decode(file_get_contents($snap), true);
              if (!$j) { exit(0); }
              $o = [
                "run_id"=>$j["run_id"] ?? null,
                "timestamp"=>$j["timestamp"] ?? null,
                "site"=>[
                  "url"=>$j["site"]["url"] ?? null,
                  "wp_version"=>$j["site"]["wp_version"] ?? null,
                  "php_version"=>$j["site"]["php_version"] ?? null
                ],
                "counts"=>$j["summary"]["counts"] ?? [],
                "active_plugins"=>$j["summary"]["plugins_active"] ?? [],
                "errors"=>$j["summary"]["errors"] ?? []
              ];
              $out = getenv("OUT") ?: "";
              if ($out !== "") file_put_contents($out, json_encode($o, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE));
              echo json_encode($o, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE);
            ' | tee -a "$GITHUB_STEP_SUMMARY"

            if [[ -n "${SITE_KEY:-}" ]]; then
              sshpass -p "${PASS}" ssh -p "${PORT}" -o StrictHostKeyChecking=yes \
                "${USER}@${HOST}" "mkdir -p \"${TARGET}/wp-content/uploads/wtp-ro/public/${SITE_KEY}\""
              sshpass -p "${PASS}" scp -P "${PORT}" -o StrictHostKeyChecking=yes \
                "_ci_logs/${{ github.run_id }}/snapshot/snapshot-summary.json" \
                ${USER}@${HOST}:"${TARGET}/wp-content/uploads/wtp-ro/public/${SITE_KEY}/snapshot-summary.json"
              echo "::notice::RO summary: ${SITE_URL:-https://weektoppick.com}/wp-content/uploads/wtp-ro/public/${SITE_KEY}/snapshot-summary.json"
            else
              echo "::warning::SITE_KEY not set → public summary skipped."
            fi
          else
            echo "::warning::No snapshot.json to summarize."
          fi

      - name: 9) Report summary
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          ERR="_ci_logs/${{ github.run_id }}/snapshot/errors.txt"
          if [[ -s "$ERR" ]]; then
            echo "::group::Snapshot errors"
            cat "$ERR" || true
            echo "::endgroup::"
            while IFS= read -r line; do
              [[ -n "$line" ]] && echo "::warning::$line"
            done < "$ERR"
          fi
          if [[ -n "${SITE_KEY:-}" ]]; then
            echo "::notice::RO latest: ${SITE_URL:-https://weektoppick.com}/wp-content/uploads/wtp-ro/public/${SITE_KEY}/snapshot.json"
            echo "::notice::RO run:    ${SITE_URL:-https://weektoppick.com}/wp-content/uploads/wtp-ro/public/${SITE_KEY}/snapshot-${{ github.run_id }}.json"
          else
            echo "::warning::RO URLs not printed (SITE_KEY empty)."
          fi
          echo "::notice::03_snapshot completed for run ${{ github.run_id }}."

  publish_snapshot:
    needs: snapshot
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download snapshot artifact
        uses: actions/download-artifact@v4
        with:
          name: snapshot-logs-${{ github.run_id }}
          path: _ci_logs/${{ github.run_id }}/snapshot/

      - name: Commit snapshot.json to repo (versioned + latest)
        shell: bash
        run: |
          set -euo pipefail
          SRC="_ci_logs/${{ github.run_id }}/snapshot/snapshot.json"
          DEST_DIR=".wtp/snapshots"
          DEST_VER="${DEST_DIR}/snapshot-${{ github.run_id }}.json"
          DEST_LATEST="${DEST_DIR}/snapshot-latest.json"

          [[ -s "$SRC" ]] || { echo "::error::snapshot.json missing"; exit 1; }
          mkdir -p "$DEST_DIR"
          cp "$SRC" "$DEST_VER"
          cp "$SRC" "$DEST_LATEST"

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$DEST_VER" "$DEST_LATEST"
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit."
          else
            git commit -m "Snapshot ${GITHUB_RUN_ID}: add ${DEST_VER} and update snapshot-latest.json"
            git push
          fi

      - name: Print RAW URLs (for external analysis)
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          echo "::notice::RAW latest: https://raw.githubusercontent.com/${REPO}/${BRANCH}/.wtp/snapshots/snapshot-latest.json"
          echo "::notice::RAW run:    https://raw.githubusercontent.com/${REPO}/${BRANCH}/.wtp/snapshots/snapshot-${{ github.run_id }}.json"

  diff_snapshot:
    needs: publish_snapshot
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repo (with history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Locate latest & previous snapshots
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          DIR=".wtp/snapshots"
          mkdir -p "$DIR"
          # zbierz ID runów z plików snapshot-<id>.json
          RUNS=$(ls -1 "$DIR"/snapshot-*.json 2>/dev/null \
            | grep -v 'snapshot-latest.json' \
            | sed -E 's#.*/snapshot-([0-9]+)\.json#\1#' | sort -n || true)
          if [[ -z "${RUNS}" ]]; then
            echo "found=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          LAST_RUN=$(echo "$RUNS" | tail -n1)
          PREV_RUN=$(echo "$RUNS" | tail -n2 | head -n1)
          if [[ "$LAST_RUN" == "$PREV_RUN" || -z "$PREV_RUN" ]]; then
            echo "found=1"   >> $GITHUB_OUTPUT
            echo "last=$LAST_RUN" >> $GITHUB_OUTPUT
            echo "prev="     >> $GITHUB_OUTPUT
          else
            echo "found=2"   >> $GITHUB_OUTPUT
            echo "last=$LAST_RUN" >> $GITHUB_OUTPUT
            echo "prev=$PREV_RUN" >> $GITHUB_OUTPUT
          fi

      - name: Build diff report (PHP, no jq)
        if: steps.pick.outputs.found != '0'
        shell: bash
        run: |
          set -euo pipefail
          LAST_ID="${{ steps.pick.outputs.last }}"
          PREV_ID="${{ steps.pick.outputs.prev }}"
          LAST=".wtp/snapshots/snapshot-${LAST_ID}.json"
          [[ -n "${PREV_ID}" ]] && PREV=".wtp/snapshots/snapshot-${PREV_ID}.json" || PREV=""
          OUT="_ci_logs/${{ github.run_id }}/snapshot/snapshot-diff.json"
          mkdir -p "_ci_logs/${{ github.run_id }}/snapshot"

          LAST="$LAST" PREV="$PREV" OUT="$OUT" php -r '
            function j($p){
              if (!$p || !is_readable($p)) return null;
              $t = file_get_contents($p);
              return $t!==false ? (json_decode($t, true) ?? null) : null;
            }
            function setv($a){ return array_values(array_unique(is_array($a)?$a:[])); }

            $last = j(getenv("LAST"));
            $prev = j(getenv("PREV"));
            $out  = ["last_run"=>$last["run_id"]??null,"prev_run"=>$prev["run_id"]??null];

            if(!$last){
              file_put_contents(getenv("OUT"), json_encode($out));
              exit;
            }

            $la = setv($last["summary"]["plugins_active"]??[]);
            $pa = setv($prev["summary"]["plugins_active"]??[]);
            $added   = array_values(array_diff($la,$pa));
            $removed = array_values(array_diff($pa,$la));

            $lt = is_array($last["plugins"]["trees"]??null)? $last["plugins"]["trees"] : [];
            $pt = is_array($prev["plugins"]["trees"]??null)? $prev["plugins"]["trees"] : [];
            $changedTrees = [];
            foreach ($lt as $slug=>$meta){
              $ls = $meta["sha1"]??"";
              $ps = $pt[$slug]["sha1"]??"";
              if($ps!=="" && $ls!==$ps){ $changedTrees[$slug]=["prev"=>$ps,"last"=>$ls]; }
            }

            $lmu = is_array($last["plugins"]["must_use"]??null)? count($last["plugins"]["must_use"]) : 0;
            $pmu = is_array($prev["plugins"]["must_use"]??null)? count($prev["plugins"]["must_use"]) : 0;

            $ladm = setv($last["admins"]??[]);
            $padm = setv($prev["admins"]??[]);
            $admins_added   = array_values(array_diff($ladm,$padm));
            $admins_removed = array_values(array_diff($padm,$ladm));

            $ssot_last = $last["wtp"]["ssot_sha1"]??"";
            $ssot_prev = $prev["wtp"]["ssot_sha1"]??"";
            $ssot_changed = ($prev && $ssot_last!==$ssot_prev) ? ["prev"=>$ssot_prev,"last"=>$ssot_last] : null;

            $out += [
              "site"=>$last["site"]["url"]??null,
              "versions"=>["wp"=>$last["site"]["wp_version"]??null, "php"=>$last["site"]["php_version"]??null],
              "plugins"=>[
                "total"=>$last["summary"]["counts"]["plugins_total"]??null,
                "active_total"=>$last["summary"]["counts"]["plugins_active"]??null,
                "mu_total"=>$last["summary"]["counts"]["plugins_mu"]??null,
                "active_added"=>$added,
                "active_removed"=>$removed,
                "trees_changed"=>$changedTrees
              ],
              "admins"=>["added"=>$admins_added,"removed"=>$admins_removed],
              "ssot_changed"=>$ssot_changed,
              "errors"=>$last["summary"]["errors"]??[]
            ];
            file_put_contents(getenv("OUT"), json_encode($out, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE));
          '

          echo "Built diff to $OUT"

      - name: Upload diff artifact
        if: steps.pick.outputs.found != '0'
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-diff-${{ github.run_id }}
          path: _ci_logs/${{ github.run_id }}/snapshot/snapshot-diff.json

      - name: Print diff summary + alerts
        if: steps.pick.outputs.found != '0'
        shell: bash
        run: |
          set -euo pipefail
          DIFF="_ci_logs/${{ github.run_id }}/snapshot/snapshot-diff.json"
          DIFF="$DIFF" php -r '
            $p=getenv("DIFF") ?: "";
            if($p==="" || !is_readable($p)){ exit; }
            $d=json_decode(file_get_contents($p),true)?:[];
            echo "## Snapshot diff\n\n";
            echo "- Site: ".($d["site"]??"n/a")."\n";
            echo "- Runs: last=".($d["last_run"]??"")." prev=".($d["prev_run"]??"")."\n";
            echo "- WP/PHP: ".(($d["versions"]["wp"]??"n/a")." / ".($d["versions"]["php"]??"n/a"))."\n";
            $added = $d["plugins"]["active_added"]??[];
            $removed = $d["plugins"]["active_removed"]??[];
            $trees = $d["plugins"]["trees_changed"]??[];
            $admA = $d["admins"]["added"]??[];
            $admR = $d["admins"]["removed"]??[];
            $ssot = $d["ssot_changed"]??null;

            if($added){ echo "::warning::Active plugins added: ".implode(",", $added)."\n"; }
            if($removed){ echo "::warning::Active plugins removed: ".implode(",", $removed)."\n"; }
            if($trees && count($trees)>0){ echo "::warning::Plugin files changed (trees sha): ".implode(",", array_keys($trees))."\n"; }
            if($admA){ echo "::warning::Admins added: ".implode(",", $admA)."\n"; }
            if($admR){ echo "::warning::Admins removed: ".implode(",", $admR)."\n"; }
            if($ssot){ echo "::warning::SSOT changed: prev=".$ssot["prev"]." -> last=".$ssot["last"]."\n"; }

            echo "\n### Changes\n\n";
            echo "- Active plugins added: ".(empty($added)?"—":implode(", ",$added))."\n";
            echo "- Active plugins removed: ".(empty($removed)?"—":implode(", ",$removed))."\n";
            echo "- Plugins with file hash changes: ".(empty($trees)?"—":implode(", ",array_keys($trees)))."\n";
            echo "- Admins added: ".(empty($admA)?"—":implode(", ",$admA))."\n";
            echo "- Admins removed: ".(empty($admR)?"—":implode(", ",$admR))."\n";
            if($ssot){ echo "- SSOT changed.\n"; } else { echo "- SSOT unchanged or unavailable.\n"; }
          ' | tee -a "$GITHUB_STEP_SUMMARY"
