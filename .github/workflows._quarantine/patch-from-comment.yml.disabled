name: Create Patch From Comment

on:
  issue_comment:
    types: [created]
  workflow_dispatch: {}

permissions:
  contents: write
  issues: read

concurrency:
  group: patch-from-comment
  cancel-in-progress: true

jobs:
  from-comment:
    if: ${{ github.event_name == 'issue_comment' && ( startsWith(github.event.comment.body, '# patch') || contains(github.event.comment.body, '```patch') || contains(github.event.comment.body, '```diff') ) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Extract patch from comment & save to .wtp/inbox/
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.comment.body || '';

            const fenced = body.match(/```(?:patch|diff)\s+([\s\S]*?)```/i);
            const head = body.startsWith('# patch') ? body.replace(/^# patch\s*/i, '') : null;

            const patch = (fenced && fenced[1]) ? fenced[1].trim() : (head ? head.trim() : '');
            if (!patch) core.setFailed('No patch block found. Use ```patch ...``` or start message with "# patch".');

            const ts  = new Date().toISOString().replace(/[-:]/g,'').replace(/\..*/,'Z');
            const num = String(context.payload.comment.id).slice(-6);
            const filename = `.wtp/inbox/${num}-${ts}.patch`;

            fs.mkdirSync('.wtp/inbox', { recursive: true });
            fs.writeFileSync(filename, patch + '\n', { encoding:'utf8' });
            core.setOutput('filename', filename);

      - name: Commit patch file
        run: |
          git config user.name  "wtp-bot"
          git config user.email "wtp-bot@users.noreply.github.com"
          git add .wtp/inbox/
          git commit -m "inbox: add ${{ steps.extract.outputs.filename }} from issue comment"
          git push origin HEAD:main
