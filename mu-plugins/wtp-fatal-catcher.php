<?php /**  * Plugin Name: WTP Fatal Catcher  * Description: Łapie FATALe i zapisuje je do wp-content/uploads/wtp-logs/wp-fatal-latest.txt (+ meta). Pokazuje prosty komunikat zamiast białej strony.  * Author: WTP  * Version: 0.1  */  if (defined('WP_INSTALLING') && WP_INSTALLING) { return; }  add_action('muplugins_loaded', function () {     // Maksymalny poziom raportowania     @error_reporting(E_ALL);     @ini_set('display_errors', '0'); // nie krzycz w HTML (żeby nie rozjeżdżać stron)     @ini_set('log_errors', '1');      // Ścieżki logów     $upload_dir = wp_get_upload_dir();     $wtp_dir    = trailingslashit($upload_dir['basedir']) . 'wtp-logs/';     if (!is_dir($wtp_dir)) { wp_mkdir_p($wtp_dir); }     $log_file   = $wtp_dir . 'wp-fatal-latest.txt';     $meta_file  = $wtp_dir . 'wp-fatal-meta.json';      // Zapamiętaj ścieżki w globalu, żeby inne MU/temat mogły je znaleźć     $GLOBALS['WTP_FATAL_LOG'] = $log_file;      // Zarejestruj catcher     register_shutdown_function(function () use ($log_file, $meta_file) {         $e = error_get_last();         if (!$e || !in_array($e['type'], [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR])) {             return;         }         // Zapisz log + meta         $lines = [             '=== WTP FATAL ===',             'time: ' . gmdate('c'),             'type: ' . $e['type'],             'message: ' . $e['message'],             'file: ' . $e['file'],             'line: ' . $e['line'],             'request: ' . ( $_SERVER['REQUEST_METHOD'] ?? '-' ) . ' ' . ( $_SERVER['REQUEST_URI'] ?? '-' ),             'referrer: ' . ( $_SERVER['HTTP_REFERER'] ?? '-' ),             'user-agent: ' . ( $_SERVER['HTTP_USER_AGENT'] ?? '-' ),             '',         ];         @file_put_contents($log_file, implode("\n", $lines), LOCK_EX);          $meta = [             'time'    => gmdate('c'),             'php'     => PHP_VERSION,             'wp'      => get_bloginfo('version'),             'theme'   => wp_get_theme()->get('Name') . ' ' . wp_get_theme()->get('Version'),             'request' => ( $_SERVER['REQUEST_METHOD'] ?? '-' ) . ' ' . ( $_SERVER['REQUEST_URI'] ?? '-' ),         ];         @file_put_contents($meta_file, json_encode($meta, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES), LOCK_EX);          // Zamiast białej strony: krótki, bezpieczny komunikat (200ms)         if (!headers_sent()) { header('Content-Type: text/plain; charset=utf-8'); }         echo "WTP fatal captured. See: wp-content/uploads/wtp-logs/wp-fatal-latest.txt\n";         // zatrzymaj normalny output         wp_die('', '', ['response' => 500]);     }); });