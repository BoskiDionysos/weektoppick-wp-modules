name: Apply Inbox Patch

on:
  push:
    branches: [ main ]
    paths:
      - ".wtp/inbox/*.patch"
  workflow_dispatch: {}

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name  "wtp-bot"
          git config user.email "wtp-bot@users.noreply.github.com"

      - name: Ensure folders
        run: |
          mkdir -p .wtp/inbox .wtp/processed ops

      - name: Apply patches from inbox
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          PATCHES=(.wtp/inbox/*.patch)
          if [ ${#PATCHES[@]} -eq 0 ]; then
            echo "No patches to apply."
            exit 0
          fi

          for P in "${PATCHES[@]}"; do
            echo ">> Applying: $P"

            # Sprawdzenie czy patch ma ważne hunki
            if git apply --check --3way "$P"; then
              git apply --3way "$P"
              echo "Applied cleanly: $P"
            else
              echo "::warning::Patch may be empty or conflicting, trying relaxed apply (-3)."
              if ! git apply -3 "$P"; then
                echo "::warning::Could not apply $P (no valid hunks). Will archive anyway."
              fi
            fi

            # ZAWSZE przenieś patch do processed, by nie pętlić
            BN="$(basename "$P")"
            mv "$P" ".wtp/processed/$BN"

            # Stage wszystkiego co się zmieniło (jeśli cokolwiek)
            git add -A || true

            # Commit tylko jeżeli są zmiany
            if git diff --cached --quiet; then
              echo "No changes to commit after $BN"
            else
              git commit -m "[apply-inbox] $BN"
              git push origin HEAD:main
            fi

            echo "Processed: $BN"
          done

          echo "All patches processed."
